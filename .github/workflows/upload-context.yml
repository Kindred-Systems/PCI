name: Upload Context to OpenAI

on:
  push:
    branches:
      - main  # Runs when pushing to main
  workflow_dispatch:  # Allows manual trigger

jobs:
  update-gpt-context:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          echo "Setting up required dependencies..."

      - name: Compress files as ZIP
        run: |
          zip -r context-files.zip . -i ./context-folder/*

      - name: Upload Context to OpenAI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/files" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: multipart/form-data" \
            -F "file=@context-files.zip" \
            -F "purpose=fine-tune")

          echo "Upload Response: $RESPONSE"

      - name: Handle API Response
        run: |
          echo "Checking API Response..."
          if [[ $RESPONSE == *"error"* ]]; then
            echo "❌ Upload failed! Response:"
            echo $RESPONSE
            exit 1
          else
            echo "✅ Upload successful!"
          fi
